# Replit Environment Setup

## Version Reference
- **This Document**: replit-environment-setup.md v10
- **Linked Documents**:
 - agent-0-constitution.md
 - agent-2-system-architecture.md
 - agent-4-api-contract.md
 - agent-5-ui-specification.md
 - agent-6-implementation-orchestrator.md
 - agent-7-qa-deployment.md

## VERSION HISTORY

| Version | Date | Changes |
|---------|------|---------|
| 10 | 2026-02 | Pre-build review fix: Replaced imprecise "All 7 build artifacts" prerequisite with explicit reference to 5 pre-implementation JSON artifacts and build proof, matching Phase 0 validation logic. |
| 9 | 2026-02 | Governance reform: Adopted standard Linked Documents format per Constitution v7.0 Section Y. Removed runtime-resolved explanatory note (now the standard for all documents). No structural changes. |
| 8 | 2026-02 | Converted to runtime-resolved dependencies. Removed all agent version pins - this document reads files by name at deploy time, not by version. Eliminates cascade maintenance burden. |
| 7 | 2026-02 | Dependency pins updated: Agent 0 v6.1 -> v6.2, Agent 2 v33 -> v35, Agent 4 v46 -> v65, Agent 5 v42 -> v62, Agent 6 v66 -> v86, Agent 7 v55 -> v74. No body content changes - setup protocol remains version-agnostic. |
| 6 | 2026-02 | RESTRUCTURE: Updated for consolidated artifacts. Reads 5 JSON files instead of 7+. Removed references to route-service-contracts.json, soft-delete-cascade.json, and markdown spec fallback extraction. |
| 5 | 2026-02 | Updated to Constitution v5.1. |

---

## PURPOSE

**This document is NOT part of the Claude Code build pipeline.** It is not referenced by or invoked from the Master Build Prompt.

This prompt is used **after** code has been generated by Claude Code, committed to GitHub, and pulled into a new Replit project. Run this prompt inside Replit to configure the environment, generate config files, and validate the application runs correctly.

**Execution context:** Replit AI agent (not Claude Code)
**When to run:** After code exists in the Replit project (post-deployment)
**Prerequisite:** All 5 pre-implementation JSON artifacts and build proof must already exist in `docs/` (see Phase 0 validation)

---

## SETUP PROTOCOL

### Phase 0: Pre-Setup Validation

#### Step 0.1: Validate JSON Artifacts

```bash
echo "=== Validating JSON Artifacts ==="

REQUIRED_JSON=(
 "docs/scope-manifest.json"
 "docs/env-manifest.json"
 "docs/data-relationships.json"
 "docs/service-contracts.json"
 "docs/ui-api-deps.json"
)

MISSING=0
for file in "${REQUIRED_JSON[@]}"; do
 if [ -f "$file" ]; then
 jq empty "$file" 2>/dev/null || {
 echo "ERROR: Invalid JSON in $file"
 exit 1
 }
 echo "[OK] $file"
 else
 echo "[X] MISSING: $file"
 MISSING=$((MISSING + 1))
 fi
done

if [ $MISSING -gt 0 ]; then
 echo "ERROR: $MISSING JSON artifacts missing."
 echo "These should have been generated by the Claude Code build pipeline."
 exit 1
fi

echo "[OK] All JSON artifacts validated"
```

#### Step 0.2: Verify Specification Freeze Hash

```bash
echo "=== Verifying Specification Freeze Hash ==="

if [ -f ".spec-freeze-hash" ]; then
 EXPECTED_HASH=$(cat .spec-freeze-hash)
 CURRENT_HASH=$(cat docs/*.json | sha256sum | cut -d' ' -f1)

 if [ "$EXPECTED_HASH" = "$CURRENT_HASH" ]; then
 echo "[OK] Specification freeze hash verified"
 else
 echo "ERROR: Specification hash mismatch - specs modified after freeze"
 exit 1
 fi
else
 echo "[SKIP] No spec freeze hash found (normal if running outside full build pipeline)"
fi
```

#### Step 0.3: Validate API Contract Alignment

```bash
echo "=== Validating API Contract Alignment ==="

if [ -f "scripts/verify-route-service-alignment.sh" ]; then
 bash scripts/verify-route-service-alignment.sh || {
 echo "ERROR: Route-service alignment validation failed"
 exit 1
 }
 echo "[OK] API contract alignment validated"
else
 echo "[WARN] verify-route-service-alignment.sh not found"
fi
```

#### Step 0.4: Validate UI-API Dependencies

```bash
echo "=== Validating UI-API Dependencies ==="

if [ -f "scripts/verify-ui-api-alignment.sh" ]; then
 bash scripts/verify-ui-api-alignment.sh || {
 echo "ERROR: UI-API alignment validation failed"
 exit 1
 }
 echo "[OK] UI-API dependencies validated"
else
 echo "[WARN] verify-ui-api-alignment.sh not found"
fi
```

---

### Phase 1: Extract Configuration Requirements

#### Step 1.1: Environment Variables

Read from env-manifest.json (canonical source):

```bash
echo "=== Extracting Environment Variables ==="

# List all required env vars
jq -r '.required[] | "\(.name): \(.usage) [\(.validation)]"' docs/env-manifest.json

# List optional env vars
jq -r '.optional[]? | "\(.name): \(.usage) (default: \(.default))"' docs/env-manifest.json
```

#### Step 1.2: Build Commands

Read from 02-ARCHITECTURE.md if available, otherwise use defaults:
- Build: `npm run build`
- Start: `npm start`
- Dev: `npm run dev`

#### Step 1.3: Port Configuration

```bash
# Port from env-manifest.json
jq -r '.required[] | select(.name == "PORT") | .validation' docs/env-manifest.json 2>/dev/null

# Or from 02-ARCHITECTURE.md ADRs
grep -A2 "binding\|127\.0\.0\.1\|0\.0\.0\.0" docs/02-ARCHITECTURE.md 2>/dev/null
```

---

### Phase 2: Configure Replit Files

#### Step 2.1: Create `.replit` Configuration

```toml
run = "npm run dev"
entrypoint = "server/index.ts"

[deployment]
run = ["sh", "-c", "npm start"]
build = ["sh", "-c", "npm run build"]

[[ports]]
localPort = 5000
externalPort = 80

[env]
NODE_ENV = "production"
```

#### Step 2.2: Create `replit.nix` Configuration

```nix
{ pkgs }: {
 deps = [
 pkgs.nodejs_20
 pkgs.nodePackages.typescript-language-server
 pkgs.nodePackages.vite
 ];
}
```

#### Step 2.3: Create/Verify `vite.config.ts`

```typescript
import { defineConfig } from 'vite';
import react from '@vitejs/plugin-react';
import path from 'path';

export default defineConfig({
 plugins: [react()],
 resolve: {
 alias: {
 '@': path.resolve(__dirname, './client/src'),
 },
 },
 server: {
 host: '0.0.0.0',
 port: 5000,
 strictPort: true,
 proxy: {
 '/api': {
 target: 'http://127.0.0.1:3001',
 changeOrigin: true,
 },
 },
 watch: {
 usePolling: true,
 interval: 1000,
 ignored: ['**/node_modules/**', '**/.git/**', '**/dist/**'],
 },
 },
 clearScreen: false,
 build: {
 outDir: 'dist/public',
 emptyOutDir: true,
 },
});
```

---

### Phase 3: Generate Environment Variables

```bash
echo "=== Generating Environment Variables ==="

cat > .env << ENV
# Generated: $(date -u +"%Y-%m-%d %H:%M:%S UTC")

# Cryptographic Secrets (auto-generated)
JWT_SECRET=$(node -e "console.log(require('crypto').randomBytes(32).toString('base64url'))")

# Conditional: include ENCRYPTION_KEY only if conditionallyRequired in env-manifest.json
# Check: jq -e '.conditionallyRequired[]? | select(.name == "ENCRYPTION_KEY")' docs/env-manifest.json
# If present:
# ENCRYPTION_KEY=$(node -e "console.log(require('crypto').randomBytes(32).toString('hex'))")

# Database
DATABASE_URL="postgresql://user:password@localhost:5432/dbname"

# Application
NODE_ENV="development"
PORT="3001"

# Frontend
VITE_API_URL="/api"

ENV

echo "[OK] .env file created"
echo "[ACTION REQUIRED] Update DATABASE_URL and other placeholders"
```

---

### Phase 4: Initialise Database

```bash
echo "=== Initialising Database ==="

npm install

npm run migrate || npm run db:migrate || {
 echo "ERROR: Migration command failed"
 exit 1
}

if [ -f "scripts/seed-admin.ts" ]; then
 npm run seed || npm run db:seed || {
 echo "WARN: Seed command failed (may be optional)"
 }
fi

echo "[OK] Database initialised"
```

---

### Phase 5: Run Verification

```bash
echo "=== Running Verification ==="

if [ -f "scripts/run-all-gates.sh" ]; then
 echo "Using canonical gate runner"
 bash scripts/run-all-gates.sh || {
 echo "[X] Gate runner failed - check docs/build-gate-results.json"
 exit 1
 }
 echo "[OK] All gates passed"
else
 echo "[WARN] scripts/run-all-gates.sh not found"
 echo "Running individual verification scripts as fallback"

 FAILED_SCRIPTS=0
 for script in scripts/verify-*.sh; do
 if [ -f "$script" ]; then
 bash "$script" || { FAILED_SCRIPTS=$((FAILED_SCRIPTS + 1)); }
 fi
 done

 if [ $FAILED_SCRIPTS -gt 0 ]; then
 echo "[WARN] $FAILED_SCRIPTS verification script(s) failed"
 fi
fi
```

---

### Phase 6: Test Application

```bash
echo "=== Starting Development Server ==="

npm run dev &
DEV_PID=$!

TIMEOUT=30
ELAPSED=0
BACKEND_PORT=$(grep "^PORT=" .env | cut -d= -f2)
BACKEND_PORT=${BACKEND_PORT:-3001}

HEALTH_PATH=$(jq -r '.endpoints[] | select(.path | contains("health")) | .path' docs/service-contracts.json 2>/dev/null | head -1)
HEALTH_PATH=${HEALTH_PATH:-"/health"}

echo "Waiting for server on port $BACKEND_PORT..."

while [ $ELAPSED -lt $TIMEOUT ]; do
 if curl -s "http://localhost:$BACKEND_PORT${HEALTH_PATH}" > /dev/null 2>&1; then
 echo "[OK] Server ready"
 break
 fi
 sleep 1
 ELAPSED=$((ELAPSED + 1))
done

if [ $ELAPSED -ge $TIMEOUT ]; then
 echo "[X] Server failed to start within $TIMEOUT seconds"
 kill $DEV_PID 2>/dev/null
 exit 1
fi

HEALTH_RESPONSE=$(curl -s "http://localhost:$BACKEND_PORT${HEALTH_PATH}")

if echo "$HEALTH_RESPONSE" | jq -e '.status == "healthy"' > /dev/null 2>&1; then
 echo "[OK] Health check passed"
else
 echo "[X] Health check failed"
 kill $DEV_PID 2>/dev/null
 exit 1
fi

kill $DEV_PID 2>/dev/null
echo "[OK] Development server test complete"
```

---

### Phase 7: Final Verification

```bash
echo "=== Final Compliance Check ==="

COMPLIANCE_ISSUES=0

echo "Checking JSON contracts..."
for file in docs/scope-manifest.json docs/service-contracts.json docs/env-manifest.json docs/data-relationships.json docs/ui-api-deps.json; do
 if [ ! -f "$file" ]; then
 echo "[X] Missing: $file"
 COMPLIANCE_ISSUES=$((COMPLIANCE_ISSUES + 1))
 fi
done

echo "Checking mandatory files..."
MANDATORY_FILES=(".replit" "replit.nix" "vite.config.ts" ".env" "package.json")

for file in "${MANDATORY_FILES[@]}"; do
 test -f "$file" || {
 echo "[X] Missing mandatory file: $file"
 COMPLIANCE_ISSUES=$((COMPLIANCE_ISSUES + 1))
 }
done

if [ $COMPLIANCE_ISSUES -eq 0 ]; then
 echo "[OK] Compliance verified"
else
 echo "[X] $COMPLIANCE_ISSUES compliance issue(s) found"
 exit 1
fi
```

---

## TROUBLESHOOTING

**Issue: JSON artifacts missing**
- Cause: Build pipeline not run or files not committed
- Fix: Ensure Claude Code build completed and all docs/*.json files are in the repo

**Issue: Server fails to start**
- Cause: Missing environment variables, port conflicts
- Fix: Check .env file, verify PORT setting, check logs

**Issue: Health check endpoint not found**
- Cause: Health endpoint path not in service-contracts.json
- Fix: Ensure service-contracts.json includes health endpoint

---

## PROMPT HYGIENE GATE

- [OK] Version Reference block present with runtime-resolved dependencies (no agent version pins)
- [OK] No dependency version pins outside Version Reference and VERSION HISTORY (Section Y compliant)
- [OK] Reads 5 JSON files (was 7)
- [OK] No markdown fallback extraction (removed fragile pattern)
- [OK] Health endpoint discovered dynamically from service-contracts.json
- [OK] Australian English (initialise, optimised)
- [OK] No non-ASCII characters

**Validation Date:** 2026-02-05
**Status:** Production Ready
